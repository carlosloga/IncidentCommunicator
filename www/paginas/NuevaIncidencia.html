<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Nova incidencia</title>  
        <!-- !CSS -->
    <link href="../css/jquery.mobile-1.3.1.min.css" rel="stylesheet" type="text/css" />
    <link href="../css/jquery.mobile.datebox-1.0.1.min.css" rel="Stylesheet" type="text/css" />

    <script src="../js/jquery-1.6.4.min.js" type="text/javascript"></script>
    <script src="../js/jquery.mobile-1.3.1.min.js" type="text/javascript"></script>
    <script src="../js/jquery.mobile.datebox-1.0.1.min.js" type="text/javascript"></script> 
    <script src="../js/jquery.json-2.2.min.js" type="text/javascript"></script> 

    <!--Mapa-->    
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=true"></script>

    <script src="../negocio/utilitats.js" type="text/javascript"></script> 
    <script src="../negocio/webService.js" type="text/javascript"></script>

    <!--<script type="text/javascript" charset="utf-8" src="../cordova.js"></script>-->
</head>
<body>
    <div data-role="page" id="pageNuevaIncidencia">
        <div data-role="header" data-theme="f">            
            <a href="../index.html" data-icon="home" data-iconpos="notext" data-direction="reverse">Home</a>
            <h3>Comunicació de nova incidència</h3>
            <a href="../paginas/Info.html" data-icon="info" data-iconpos="notext" data-direction="reverse">Info</a>
        </div>
        <div data-role="content" data-theme="a" data-mini="true">
                <div id="acordeon" data-role="collapsible-set" data-mini="true" data-collapsed-icon="arrow-r" data-expanded-icon="arrow-l" data-thene="b" data-content-theme="b">
                 <div data-role="collapsible" data-mini="true" id="collapsibleFoto">   <!--data-collapsed="false"-->
                    <h3><table style="width:100%;"><tr><td style="text-align:left; width:100%;">recollir proves</td><td style="text-align:right;"><a href="#" id="buttonCamara" onclick="hacerFoto()"  data-mini="true" data-inline="true" data-role="button" data-theme="b" data-icon="false">càmara</a></td></tr></table></h3>                    
<!--                <div class="ui-grid-a">
                      <div class="ui-block-a"><img id="imgFoto" src="" width="100%" alt="prova de la incidència" /></div>
                      <div class="ui-block-b"><a href="#" id="buttonEliminarFoto" onclick="eliminarFoto()"  data-mini="true" data-inline="true" data-role="button" data-theme="b" data-icon="false">el·liminar</a></div>
                    </div>-->

                    <table style="width:100%;"><tr>
                        <td style="text-align:left; width:100%;"><img id="imgFoto" src="" width="100%" alt="prova de la incidència" /></td>
                        <td style="text-align:right;"><a href="#" id="buttonEliminarFoto" onclick="eliminarFoto()"  data-mini="true" data-inline="true" data-role="button" data-theme="b" data-icon="false">el·liminar</a></td>
                    </tr></table>
                    
                  </div>
                  <div data-role="collapsible" data-mini="true" id="collapsibleComentario">
                    <h3><table style="width:100%;"><tr><td>comentari</td><td style="text-align:right;"><label id="labelComentari" style="font-size:x-small;"></label></td></tr></table></h3>
                    <!--<textarea name="textareaComentari" id="textareaComentari" data-theme="b" cols="40" rows="3" data-mini="true"></textarea>-->
                    <input type="text" name="textareaComentari" id="textareaComentari" value="" />
                  </div>
                  <div data-role="collapsible" data-mini="true" id="collapsibleLocalizacion" data-collapsed="false">
                    <h3><table style="width:100%;"><tr><td>localització</td><td style="text-align:right;"><label id="labelDireccion" style="font-size:x-small;"></label></td></tr></table></h3>
                    <div class="ui-bar-c ui-corner-all ui-shadow" style="padding:1em;">
					    <div id="divMapa" style="height:200px;"></div>
				    </div>
                  </div>                  
                </div>
                <div style="text-align:right;">
                <a href="#" id="buttonEnviar" onclick="enviarIncidencia()" data-mini="true" data-inline="false" data-role="button" data-theme="b" data-icon="grid">ENVIAR</a>
                </div>
        </div>

        <div data-role="footer" data-theme="f" data-position="fixed" style="text-align: center;">
            <table style="width:100%;"><tr><td style="background-color:LightGrey; width:100%;"><label for="basic" id="labelPieNuevaIncidencia" style="color:Gray; font-size:small; font-weight:normal; background-color:LightGrey;">&#169;2013 SETTING Consultoria en T.I., S.L.</label></td></tr></table>
       </div>   

        <script type="text/javascript">            
            var map;
            var pos = null;
            var global_AjaxERROR = '';
            var global_AjaxRESULTADO = null;
            var sDireccion = '';

            var pictureSource;   // picture source
            var destinationType; // sets the format of returned value

            if (phoneGapRun()) {
                document.addEventListener("deviceready", onDeviceReady, false);
            } else {
                onDeviceReady(); //this is the browser
            }
            //document.addEventListener("deviceready", onDeviceReady, false);

            //$("#pageIndex").live('pageinit', function () {  
            function onDeviceReady() {
                if (phoneGapRun()) {
                    pictureSource = navigator.camera.PictureSourceType;
                    destinationType = navigator.camera.DestinationType;
                }
            }

            //Al cerrarse el aordeón del Comentari, que se ponga el texto en su cabecera
            $('#collapsibleComentario').bind('collapse', function () {
                $('#labelComentari').text( $('#textareaComentari').val() );
            });

// -------- ABRIR CAMARA PARA HACER FOTO --------------------------------------------------------
            function hacerFoto() {
                //iniciaMapa(false);

                try {
                    //navigator.camera.getPicture(hacerfotoOK, hacerFotoERROR, { quality: 50, destinationType: Camera.DestinationType.DATA_URL, sourceType: Camera.PictureSourceType.CAMERA, encodingType: Camera.EncodingType.JPEG, saveToPhotoAlbum: false });
                    navigator.device.capture.captureImage(hacerfotoOK, hacerFotoERROR, {limit:1});
                }
                catch (e) {
                    alert('Exception : ' + e.message);
                }
            }

            function hacerfotoOK(imageData) {
//                var imagen = document.getElementById('imgFoto');
//                imagen.style.display = 'block'
//                imagen.src = "data:image/jpeg;base64," + imageData;
                mensaje('Capturada : ' + imageData[0]);
            }

            function hacerFotoERROR(error) {
                mensaje('Error capturant : ' + error.code);
            }


// -------- LOCALIZACIÓN -----------------------------------------------------------------------            
//            $('#pageNuevaIncidencia').live('pageshow', function (event, ui) {
//                iniciaMapa();  
//            });

            $('#pageNuevaIncidencia').live('pageinit', function () {
                iniciaMapa(true);                
            });

            function iniciaMapa(bAbrir) {
                var mapOptions = {
                    zoom: 14,
                    mapTypeId: google.maps.MapTypeId.ROADMAP
                };
                map = new google.maps.Map(document.getElementById('divMapa'), mapOptions);

                // Try HTML5 geolocation
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function (position) {
                        pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                        sDireccion = cogerDireccion(pos);
                        var infowindow = new google.maps.InfoWindow({
                            map: map,
                            position: pos,
                            content: '<div><table><tr><td style="font-size:x-small; font-weight:bold;">reportar incidència en </td></tr><tr><td style="font-size:x-small; font-weight:normal;">' + sDireccion + '</td></tr></table></div>',
                            maxWidth: 300
                        });

                        var marker = new google.maps.Marker({
                            position: pos,
                            map: map,
                            title: 'incidència aquí'
                        });

                        map.setCenter(pos);

                        $('#labelDireccion').text(sDireccion);

                        $('#divMapa').gmap('refresh');

                        if (!bAbrir) $('#collapsibleLocalizacion').trigger('collapse');


                    }, function () {
                        handleNoGeolocation(true);
                    });
                } else {
                    // Browser doesn't support Geolocation
                    handleNoGeolocation(false);
                }
            }

            function handleNoGeolocation(errorFlag) {
                if (errorFlag) {
                    var content = 'Error en el servei de geolocalització.';
                } else {
                    var content = 'Error: el seu navegador no soporta geolocalització';
                }
                var options = {
                    map: map,
                    position: new google.maps.LatLng(41.97430, 2.78241),
                    content: content
                };
                var infowindow = new google.maps.InfoWindow(options);
                map.setCenter(options.position);
            }

            function cogerDireccion(pos) {
                var llamaWS = "http://maps.googleapis.com/maps/api/geocode/xml?latlng=" + pos.toString().replace(" ", "").replace("(","").replace(")","") + "&sensor=true";
                //alert(llamaWS);
                datos = LlamaWebService('GET', llamaWS, 'application/x-www-form-urlencoded', true, 'xml', false, false, 10000, null, null);
                if (global_AjaxERROR != '') alert(global_AjaxERROR);
                else 
                {
                    var sDireccion = $(datos).find('formatted_address').text();
                    var n = 0;
                    $(datos).find('formatted_address').each(function () {
                        if (n == 0) sDireccion = $(this).text();
                        n++;
                    });                    
                    return sDireccion;
                }

            }

// -------- ENVIAR INCIDENCIA -----------------------------------------------------------------------    
            function enviarIncidencia() {
                alert('enviando ando ...');
            }

        </script>
     </div>
</body>
</html>
